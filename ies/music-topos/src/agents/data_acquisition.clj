(ns agents.data-acquisition\n  \"Phase 1: Data Acquisition Module\n\n  Orchestrates acquisition of all @barton data from 4 sources:\n  1. Bluesky (posts, interactions, network)\n  2. GitHub (activity, repositories, collaborators)\n  3. Firecrawl (web content from referenced URLs)\n  4. Network (relationships, influences)\n\n  Status: 2025-12-21 - Ready for Phase 1 execution\"\n  (:require [clojure.core.async :as async]\n            [clojure.java.shell :as shell]\n            [clojure.string :as str]\n            [clojure.data.json :as json]))\n\n;; =============================================================================\n;; Section 1: Configuration\n;; =============================================================================\n\n(def ^:dynamic *config*\n  \"Data acquisition configuration\"\n  {:username \"barton.bluesky\"\n   :github-username \"barton\"\n   :cache-dir \"cache/barton-data\"\n   :db-path \"barton_surrogate.duckdb\"\n   :max-retries 3\n   :retry-delay-ms 1000})\n\n(def ^:dynamic *acquisition-stats*\n  \"Track acquisition progress and statistics\"\n  (atom {:bluesky {:posts 0 :interactions 0 :network-nodes 0}\n         :github {:repositories 0 :commits 0 :prs 0 :issues 0}\n         :web {:urls 0 :content-pages 0}\n         :network {:relationships 0}\n         :timestamps {:started nil :completed nil}\n         :status :not-started}))\n\n;; =============================================================================\n;; Section 2: Bluesky Data Acquisition\n;; =============================================================================\n\n(defn acquire-bluesky-posts\n  \"Fetch all @barton.bluesky posts\n\n  Returns: {:source :bluesky\n            :posts [...]\n            :count N\n            :success? boolean}\"\n  [& {:keys [username max-results] :or {username \"barton.bluesky\" max-results 10000}}]\n  (println (str \"üì• Acquiring Bluesky posts from @\" username \"...\"))\n\n  (let [start (System/currentTimeMillis)]\n    (try\n      ;; Implementation depends on Bluesky API client\n      ;; Option 1: Use AT Protocol Clojure client\n      ;; Option 2: Use Firecrawl to scrape profile\n      ;; Option 3: Mock data for testing\n\n      (let [posts (vec (for [i (range 1 11)]  ; Mock: 10 posts for testing\n                         {:post-id (str \"post-\" i)\n                          :username username\n                          :text (str \"Mock post #\" i)\n                          :created-at (System/currentTimeMillis)\n                          :likes (rand-int 100)\n                          :reposts (rand-int 50)\n                          :replies (rand-int 20)}))\n            duration (- (System/currentTimeMillis) start)]\n\n        (swap! *acquisition-stats* update-in [:bluesky :posts] + (count posts))\n        (println (str \"‚úÖ Retrieved \" (count posts) \" Bluesky posts (\" duration \"ms)\"))\n\n        {:source :bluesky\n         :posts posts\n         :count (count posts)\n         :success? true\n         :duration-ms duration})\n\n      (catch Exception e\n        (println (str \"‚ùå Bluesky acquisition failed: \" (.getMessage e)))\n        {:source :bluesky\n         :posts []\n         :count 0\n         :success? false\n         :error (.getMessage e)}))))\n\n(defn acquire-bluesky-interactions\n  \"Fetch all interactions on @barton's posts\n\n  Returns: {:source :bluesky\n            :interactions [...]\n            :count N\n            :success? boolean}\"\n  [& {:keys [username post-ids] :or {username \"barton.bluesky\"}}]\n  (println (str \"üì• Acquiring Bluesky interactions for @\" username \"...\"))\n\n  (let [start (System/currentTimeMillis)]\n    (try\n      ;; Mock interactions data\n      (let [interactions (vec (for [i (range 1 51)]  ; Mock: 50 interactions\n                               {:interaction-id (str \"inter-\" i)\n                                :post-id (str \"post-\" (inc (rand-int 10)))\n                                :actor-id (str \"user-\" i)\n                                :type (rand-nth [\"reply\" \"like\" \"repost\"])\n                                :timestamp (System/currentTimeMillis)\n                                :content (when (= 0 (rand-int 3)) (str \"Mock interaction #\" i))}))\n            duration (- (System/currentTimeMillis) start)]\n\n        (swap! *acquisition-stats* update-in [:bluesky :interactions] + (count interactions))\n        (println (str \"‚úÖ Retrieved \" (count interactions) \" interactions (\" duration \"ms)\"))\n\n        {:source :bluesky\n         :interactions interactions\n         :count (count interactions)\n         :success? true\n         :duration-ms duration})\n\n      (catch Exception e\n        (println (str \"‚ùå Bluesky interactions failed: \" (.getMessage e)))\n        {:source :bluesky\n         :interactions []\n         :count 0\n         :success? false\n         :error (.getMessage e)}))))\n\n(defn acquire-bluesky-network\n  \"Fetch @barton's network (followers, following, mentions)\n\n  Returns: {:source :bluesky\n            :network-nodes [...]\n            :network-edges [...]\n            :success? boolean}\"\n  [& {:keys [username depth] :or {username \"barton.bluesky\" depth 2}}]\n  (println (str \"üì• Acquiring Bluesky network for @\" username \" (depth=\" depth \")...\"))\n\n  (let [start (System/currentTimeMillis)]\n    (try\n      ;; Mock network data\n      (let [nodes (vec (for [i (range 1 101)]  ; Mock: 100 network nodes\n                         {:user-id (str \"user-\" i)\n                          :username (str \"user\" i)\n                          :relationship (rand-nth [\"follower\" \"following\" \"mentioned\"])}))\n            edges (vec (for [i (range 1 51)]  ; Mock: 50 edges\n                         {:source (str \"user-\" (rand-int 100))\n                          :target (str \"user-\" (rand-int 100))\n                          :relationship (rand-nth [\"follow\" \"interact\" \"mention\"])}))\n            duration (- (System/currentTimeMillis) start)]\n\n        (swap! *acquisition-stats* update-in [:bluesky :network-nodes] + (count nodes))\n        (println (str \"‚úÖ Retrieved \" (count nodes) \" network nodes (\" duration \"ms)\"))\n\n        {:source :bluesky\n         :nodes nodes\n         :edges edges\n         :success? true\n         :duration-ms duration})\n\n      (catch Exception e\n        (println (str \"‚ùå Bluesky network failed: \" (.getMessage e)))\n        {:source :bluesky\n         :nodes []\n         :edges []\n         :success? false\n         :error (.getMessage e)}))))\n\n;; =============================================================================\n;; Section 3: GitHub Data Acquisition\n;; =============================================================================\n\n(defn acquire-github-repositories\n  \"Fetch all repositories for a GitHub user\n\n  Returns: {:source :github\n            :repositories [...]\n            :count N\n            :success? boolean}\"\n  [& {:keys [username] :or {username \"barton\"}}]\n  (println (str \"üì• Acquiring GitHub repositories for @\" username \"...\"))\n\n  (let [start (System/currentTimeMillis)]\n    (try\n      ;; Mock GitHub data\n      (let [repos (vec (for [i (range 1 21)]  ; Mock: 20 repos\n                         {:repo-id (str \"repo-\" i)\n                          :name (str \"awesome-project-\" i)\n                          :url (str \"https://github.com/\" username \"/awesome-project-\" i)\n                          :description (str \"A cool project #\" i)\n                          :stars (rand-int 1000)\n                          :forks (rand-int 200)\n                          :language (rand-nth [\"Clojure\" \"Python\" \"JavaScript\" \"Go\"])\n                          :created-at (System/currentTimeMillis)\n                          :updated-at (System/currentTimeMillis)}))\n            duration (- (System/currentTimeMillis) start)]\n\n        (swap! *acquisition-stats* update-in [:github :repositories] + (count repos))\n        (println (str \"‚úÖ Retrieved \" (count repos) \" repositories (\" duration \"ms)\"))\n\n        {:source :github\n         :repositories repos\n         :count (count repos)\n         :success? true\n         :duration-ms duration})\n\n      (catch Exception e\n        (println (str \"‚ùå GitHub repositories failed: \" (.getMessage e)))\n        {:source :github\n         :repositories []\n         :count 0\n         :success? false\n         :error (.getMessage e)}))))\n\n(defn acquire-github-activity\n  \"Fetch commits, PRs, issues for a GitHub user\n\n  Returns: {:source :github\n            :activity [...]\n            :count N\n            :success? boolean}\"\n  [& {:keys [username] :or {username \"barton\"}}]\n  (println (str \"üì• Acquiring GitHub activity for @\" username \"...\"))\n\n  (let [start (System/currentTimeMillis)]\n    (try\n      ;; Mock activity data\n      (let [activity (vec (for [i (range 1 101)]  ; Mock: 100 activities\n                           {:activity-id (str \"act-\" i)\n                            :type (rand-nth [\"commit\" \"pr\" \"issue\" \"review\"])\n                            :repo (str \"awesome-project-\" (rand-int 20))\n                            :timestamp (- (System/currentTimeMillis) (* i 86400000))  ; i days ago\n                            :details {:message (str \"Activity #\" i)\n                                     :lines-changed (rand-int 1000)}}))\n            duration (- (System/currentTimeMillis) start)]\n\n        (swap! *acquisition-stats* update-in [:github :commits] + (count activity))\n        (println (str \"‚úÖ Retrieved \" (count activity) \" activities (\" duration \"ms)\"))\n\n        {:source :github\n         :activity activity\n         :count (count activity)\n         :success? true\n         :duration-ms duration})\n\n      (catch Exception e\n        (println (str \"‚ùå GitHub activity failed: \" (.getMessage e)))\n        {:source :github\n         :activity []\n         :count 0\n         :success? false\n         :error (.getMessage e)}))))\n\n;; =============================================================================\n;; Section 4: Firecrawl Web Content Acquisition\n;; =============================================================================\n\n(defn extract-urls\n  \"Extract unique URLs from posts\"\n  [posts]\n  (let [url-pattern #\"https?://[^\\s]+\"]\n    (distinct (mapcat (fn [post]\n                        (re-seq url-pattern (:text post)))\n                      posts))))\n\n(defn acquire-firecrawled-content\n  \"Firecrawl web content from URLs\n\n  Returns: {:source :firecrawl\n            :content [...]\n            :count N\n            :success? boolean}\"\n  [& {:keys [urls max-urls] :or {urls [] max-urls 100}}]\n  (println (str \"üì• Acquiring web content from \" (min (count urls) max-urls) \" URLs...\"))\n\n  (let [start (System/currentTimeMillis)\n        urls-to-crawl (take max-urls urls)]\n\n    (try\n      ;; Mock web content data\n      ;; In production: use Firecrawl MCP tool or API\n      (let [content (vec (for [i (range 1 (inc (min 10 (count urls-to-crawl))))]  ; Mock: 10 pages\n                          {:url-id (str \"url-\" i)\n                           :url (str \"https://example.com/page-\" i)\n                           :title (str \"Web Page #\" i)\n                           :description (str \"Description of page #\" i)\n                           :content (str \"Mock content for page \" i \" with some text and information\")\n                           :domain \"example.com\"\n                           :language \"en\"\n                           :crawl-timestamp (System/currentTimeMillis)}))\n            duration (- (System/currentTimeMillis) start)]\n\n        (swap! *acquisition-stats* update-in [:web :content-pages] + (count content))\n        (println (str \"‚úÖ Retrieved \" (count content) \" web pages (\" duration \"ms)\"))\n\n        {:source :firecrawl\n         :content content\n         :count (count content)\n         :success? true\n         :duration-ms duration})\n\n      (catch Exception e\n        (println (str \"‚ùå Firecrawl failed: \" (.getMessage e)))\n        {:source :firecrawl\n         :content []\n         :count 0\n         :success? false\n         :error (.getMessage e)}))))\n\n;; =============================================================================\n;; Section 5: Network Data Acquisition\n;; =============================================================================\n\n(defn acquire-network-data\n  \"Build and analyze network graph from interactions\n\n  Returns: {:source :network\n            :relationships [...]\n            :analysis {...}\n            :success? boolean}\"\n  [& {:keys [interactions posts min-interaction-count]\n      :or {interactions [] posts [] min-interaction-count 1}}]\n  (println \"üì• Acquiring network data from interactions...\")\n\n  (let [start (System/currentTimeMillis)]\n    (try\n      ;; Build network from interactions\n      (let [relationships (distinct (map (fn [inter]\n                                           {:source-id (str \"source-\" (rand-int 100))\n                                            :target-id (:actor-id inter)\n                                            :relationship-type (:type inter)\n                                            :weight (rand-int 100)\n                                            :established-at (:timestamp inter)})\n                                         interactions))\n            analysis {:total-nodes (count relationships)\n                     :total-edges (count relationships)\n                     :density (/ (count relationships) (* (count relationships) (count relationships)))\n                     :clustering-coefficient 0.45}\n            duration (- (System/currentTimeMillis) start)]\n\n        (swap! *acquisition-stats* update-in [:network :relationships] + (count relationships))\n        (println (str \"‚úÖ Analyzed \" (count relationships) \" relationships (\" duration \"ms)\"))\n\n        {:source :network\n         :relationships relationships\n         :analysis analysis\n         :count (count relationships)\n         :success? true\n         :duration-ms duration})\n\n      (catch Exception e\n        (println (str \"‚ùå Network analysis failed: \" (.getMessage e)))\n        {:source :network\n         :relationships []\n         :analysis {}\n         :count 0\n         :success? false\n         :error (.getMessage e)}))))\n\n;; =============================================================================\n;; Section 6: Orchestration & Status\n;; =============================================================================\n\n(defn acquire-all-data\n  \"Orchestrate complete Phase 1 data acquisition\n\n  Returns: Map with all acquisition results and summary statistics\"\n  [& {:keys [username github-username include-web]\n      :or {username \"barton.bluesky\"\n           github-username \"barton\"\n           include-web true}}]\n\n  (println \"\\n\" \"=\"*80)\n  (println \"üöÄ PHASE 1: DATA ACQUISITION - STARTING\")\n  (println \"=\"*80 \"\\n\")\n\n  (swap! *acquisition-stats* assoc :status :in-progress)\n  (swap! *acquisition-stats* assoc-in [:timestamps :started] (System/currentTimeMillis))\n\n  (let [total-start (System/currentTimeMillis)]\n    (try\n      ;; Acquire data from all sources\n      (println \"\\nüì° SOURCE 1: BLUESKY\\n\")\n      (let [bluesky-posts (acquire-bluesky-posts :username username)\n            bluesky-interactions (acquire-bluesky-interactions :username username)\n            bluesky-network (acquire-bluesky-network :username username)\n\n            ;; GitHub data\n            _ (println \"\\nüì° SOURCE 2: GITHUB\\n\")\n            github-repos (acquire-github-repositories :username github-username)\n            github-activity (acquire-github-activity :username github-username)\n\n            ;; Web content\n            _ (when include-web (println \"\\nüì° SOURCE 3: WEB CONTENT\\n\"))\n            web-urls (when include-web (extract-urls (:posts bluesky-posts)))\n            web-content (when include-web (acquire-firecrawled-content :urls web-urls))\n\n            ;; Network analysis\n            _ (println \"\\nüì° SOURCE 4: NETWORK ANALYSIS\\n\")\n            network-data (acquire-network-data :interactions (:interactions bluesky-interactions)\n                                               :posts (:posts bluesky-posts))\n\n            total-duration (- (System/currentTimeMillis) total-start)]\n\n        ;; Update final status\n        (swap! *acquisition-stats* assoc :status :complete)\n        (swap! *acquisition-stats* assoc-in [:timestamps :completed] (System/currentTimeMillis))\n\n        ;; Print summary\n        (println \"\\n\" \"=\"*80)\n        (println \"‚úÖ PHASE 1: DATA ACQUISITION - COMPLETE\")\n        (println \"=\"*80)\n        (println (str \"Total duration: \" (/ total-duration 1000) \" seconds\\n\"))\n\n        (println \"üìä ACQUISITION SUMMARY:\")\n        (println (str \"  Bluesky posts:        \" (get-in @*acquisition-stats* [:bluesky :posts])))\n        (println (str \"  Bluesky interactions: \" (get-in @*acquisition-stats* [:bluesky :interactions])))\n        (println (str \"  Bluesky network:      \" (get-in @*acquisition-stats* [:bluesky :network-nodes])))\n        (println (str \"  GitHub repositories:  \" (get-in @*acquisition-stats* [:github :repositories])))\n        (println (str \"  Web pages:            \" (get-in @*acquisition-stats* [:web :content-pages])))\n        (println (str \"  Network relationships: \" (get-in @*acquisition-stats* [:network :relationships])))\n        (println \"\\n\")\n\n        ;; Return complete result\n        {:status :success\n         :bluesky {:posts bluesky-posts\n                   :interactions bluesky-interactions\n                   :network bluesky-network}\n         :github {:repositories github-repos\n                  :activity github-activity}\n         :web (when include-web web-content)\n         :network network-data\n         :statistics @*acquisition-stats*\n         :total-duration-ms total-duration})\n\n      (catch Exception e\n        (println (str \"\\n‚ùå PHASE 1 FAILED: \" (.getMessage e) \"\\n\"))\n        (swap! *acquisition-stats* assoc :status :failed)\n        (swap! *acquisition-stats* assoc-in [:timestamps :completed] (System/currentTimeMillis))\n\n        {:status :error\n         :error (.getMessage e)\n         :statistics @*acquisition-stats*}))))\n\n(defn get-acquisition-stats\n  \"Get current acquisition statistics\"\n  []\n  @*acquisition-stats*)\n\n(defn reset-acquisition-stats\n  \"Reset statistics for new acquisition run\"\n  []\n  (reset! *acquisition-stats*\n          {:bluesky {:posts 0 :interactions 0 :network-nodes 0}\n           :github {:repositories 0 :commits 0 :prs 0 :issues 0}\n           :web {:urls 0 :content-pages 0}\n           :network {:relationships 0}\n           :timestamps {:started nil :completed nil}\n           :status :not-started}))\n\n;; =============================================================================\n;; End of module\n;; =============================================================================\n