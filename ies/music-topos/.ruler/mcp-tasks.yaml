# MCP Tasks Configuration
# Self-rewriting capabilities via Model Context Protocol Tasks
# https://modelcontextprotocol.io/specification/draft/basic/utilities/tasks

version: "2024-11-05"
namespace: music-topos

# ═══════════════════════════════════════════════════════════════════════════════
# TASK DEFINITIONS
# ═══════════════════════════════════════════════════════════════════════════════

tasks:
  # ─────────────────────────────────────────────────────────────────────────────
  # Skill Discovery & Installation
  # ─────────────────────────────────────────────────────────────────────────────
  skill-discovery:
    name: "Discover New Skills"
    description: "Crawl web resources to discover new AI agent skills"
    tools:
      - firecrawl
      - exa
    sources:
      - https://github.com/topics/ai-agent-skills
      - https://github.com/topics/mcp-server
      - https://modelcontextprotocol.io/
      - https://agentclientprotocol.com/
    output:
      format: skill-yaml
      destination: .ruler/skills/
    constraints:
      gf3_conservation: true
      max_skills_per_run: 5

  skill-installation:
    name: "Install Skill"
    description: "Install a skill to specified agent"
    parameters:
      skill_name:
        type: string
        required: true
      agent:
        type: string
        enum: [codex, claude, cursor, amp, copilot]
        default: codex
    command: "npx ai-agent-skills install {skill_name} --agent {agent}"
    post_actions:
      - verify_installation
      - update_registry

  # ─────────────────────────────────────────────────────────────────────────────
  # Skill Dispersal (Bisimulation Game)
  # ─────────────────────────────────────────────────────────────────────────────
  skill-dispersal:
    name: "Disperse Skills to All Agents"
    description: "Propagate skills across all supported agents with GF(3) conservation"
    phases:
      - name: fork
        trit: -1
        action: "Copy skills to staging"
        
      - name: propagate
        trit: 0
        action: "Distribute to agents"
        targets:
          - path: ~/.codex/skills/
            agent: codex
          - path: ~/.claude/skills/
            agent: claude
          - path: .cursor/skills/
            agent: cursor
          - path: .ruler/skills/
            agent: source-of-truth
            
      - name: verify
        trit: +1
        action: "Verify GF(3) conservation"
        
    rollback_on_failure: true
    bisimulation_check: true

  # ─────────────────────────────────────────────────────────────────────────────
  # Self-Rewriting Tasks
  # ─────────────────────────────────────────────────────────────────────────────
  self-update-skill:
    name: "Self-Update Skill"
    description: "Agent updates its own skill based on learned patterns"
    permissions:
      - write: ~/.{agent}/skills/
      - read: .ruler/skills/
    constraints:
      must_preserve: [name, description, license]
      max_diff_lines: 100
      require_review: false
    validation:
      - syntax_check
      - gf3_conservation
      - bisimulation_equivalence

  self-create-skill:
    name: "Self-Create Skill"
    description: "Agent creates new skill from discovered patterns"
    sources:
      - conversation_history
      - web_resources
      - existing_skills
    output:
      path: .ruler/skills/{skill_name}/SKILL.md
      format: markdown-frontmatter
    template: |
      ---
      name: {skill_name}
      description: "{description}"
      source: self-generated
      license: MIT
      xenomodern: true
      ---
      
      # {skill_name}
      
      {content}

  # ─────────────────────────────────────────────────────────────────────────────
  # Knowledge Extraction
  # ─────────────────────────────────────────────────────────────────────────────
  extract-from-history:
    name: "Extract Patterns from History"
    description: "Analyze interaction history for reusable patterns"
    sources:
      - ~/.codex/history.jsonl
      - ~/.zsh_history
      - .lein-repl-history
    output:
      format: skill-yaml
      destination: .ruler/skills/extracted/
    analysis:
      - command_frequency
      - tool_usage_patterns
      - conversation_topics
    min_occurrences: 3

  # ─────────────────────────────────────────────────────────────────────────────
  # Color Generation Tasks
  # ─────────────────────────────────────────────────────────────────────────────
  gay-color-task:
    name: "Generate Deterministic Colors"
    description: "Generate colors via Gay.jl MCP server"
    server: gay
    methods:
      - color_at
      - palette
      - gf3_check
    parameters:
      seed:
        type: integer
        default: 1069
      count:
        type: integer
        default: 36

  # ─────────────────────────────────────────────────────────────────────────────
  # Web Research Tasks
  # ─────────────────────────────────────────────────────────────────────────────
  research-topic:
    name: "Research Topic"
    description: "Research a topic using web tools"
    tools:
      - firecrawl
      - exa
    parameters:
      topic:
        type: string
        required: true
      depth:
        type: string
        enum: [shallow, medium, deep]
        default: medium
    output:
      format: markdown
      include_citations: true

# ═══════════════════════════════════════════════════════════════════════════════
# TASK WORKFLOWS
# ═══════════════════════════════════════════════════════════════════════════════

workflows:
  full-skill-lifecycle:
    name: "Full Skill Lifecycle"
    description: "Discover → Create → Disperse → Verify"
    steps:
      - task: skill-discovery
        on_success: skill-installation
        
      - task: skill-installation
        parameters:
          agent: all
        on_success: skill-dispersal
        
      - task: skill-dispersal
        on_success: verify-conservation
        
      - task: verify-conservation
        type: inline
        action: |
          Check GF(3) sum across all phases
          Verify bisimulation equivalence
          Report divergence metrics

  daily-maintenance:
    name: "Daily Skill Maintenance"
    schedule: "0 0 * * *"
    steps:
      - task: extract-from-history
      - task: skill-dispersal
      - task: self-update-skill
        condition: "divergence > 0.1"

# ═══════════════════════════════════════════════════════════════════════════════
# GF(3) CONSERVATION
# ═══════════════════════════════════════════════════════════════════════════════

conservation:
  law: "gf3"
  formula: "sum(trits) ≡ 0 (mod 3)"
  enforcement: strict
  
  trit_mapping:
    fork: -1        # BACKFILL - retrospective
    propagate: 0    # VERIFY - neutral
    verify: +1      # LIVE - forward
    
  violation_action: rollback

# ═══════════════════════════════════════════════════════════════════════════════
# OBSERVATIONAL BRIDGE TYPES
# ═══════════════════════════════════════════════════════════════════════════════

bridge_types:
  dimension_0:
    name: "Value"
    description: "Concrete skill content"
    
  dimension_1:
    name: "Diff"
    description: "Changes between skill versions"
    merge_strategy: 3-way
    
  dimension_2:
    name: "Conflict Resolution"
    description: "Meta-level conflict handling"
    arbiter: highest-dimension-wins
