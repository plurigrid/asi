name: Validate Skills

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Validate skills.json schema
        run: |
          echo "Validating skills.json..."
          node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('skills.json', 'utf8'));

            // Check structure
            if (!Array.isArray(data.skills)) {
              console.error('ERROR: skills must be an array');
              process.exit(1);
            }

            const required = ['name', 'description', 'category', 'author', 'license'];
            const validCategories = ['development', 'document', 'creative', 'business', 'productivity'];
            const names = new Set();
            let errors = 0;

            data.skills.forEach((skill, i) => {
              // Check required fields
              required.forEach(field => {
                if (!skill[field]) {
                  console.error('ERROR: Skill ' + skill.name + ' missing ' + field);
                  errors++;
                }
              });

              // Check category
              if (skill.category && !validCategories.includes(skill.category)) {
                console.error('ERROR: Invalid category ' + skill.category + ' for ' + skill.name);
                errors++;
              }

              // Check for duplicates
              if (names.has(skill.name)) {
                console.error('ERROR: Duplicate skill name: ' + skill.name);
                errors++;
              }
              names.add(skill.name);

              // Check name format
              if (!/^[a-z0-9][a-z0-9-]*[a-z0-9]$|^[a-z0-9]$/.test(skill.name)) {
                console.error('ERROR: Invalid skill name format: ' + skill.name);
                errors++;
              }

              // Check description length
              if (skill.description && skill.description.length < 10) {
                console.error('WARNING: Short description for ' + skill.name);
              }
            });

            if (errors > 0) {
              console.error('Found ' + errors + ' errors');
              process.exit(1);
            }

            console.log('✓ skills.json is valid (' + data.skills.length + ' skills)');
          "

      - name: Check skill folders match JSON
        run: |
          echo "Checking skill folders..."
          node -e "
            const fs = require('fs');
            const path = require('path');

            const data = JSON.parse(fs.readFileSync('skills.json', 'utf8'));
            const jsonSkills = new Set(data.skills.map(s => s.name));

            const skillsDir = 'skills';
            const folders = fs.readdirSync(skillsDir).filter(f =>
              fs.statSync(path.join(skillsDir, f)).isDirectory()
            );

            let errors = 0;

            // Check each folder has an entry in JSON
            folders.forEach(folder => {
              if (!jsonSkills.has(folder)) {
                console.error('ERROR: Folder ' + folder + ' not in skills.json');
                errors++;
              }

              // Check SKILL.md exists
              const skillMd = path.join(skillsDir, folder, 'SKILL.md');
              if (!fs.existsSync(skillMd)) {
                console.error('ERROR: Missing SKILL.md in ' + folder);
                errors++;
              }
            });

            // Check each JSON entry has a folder
            jsonSkills.forEach(name => {
              if (!folders.includes(name)) {
                console.error('ERROR: skills.json has ' + name + ' but folder missing');
                errors++;
              }
            });

            if (errors > 0) {
              process.exit(1);
            }

            console.log('✓ All ' + folders.length + ' skill folders match skills.json');
          "

      - name: Validate SKILL.md frontmatter
        run: |
          echo "Validating frontmatter..."
          node -e "
            const fs = require('fs');
            const path = require('path');

            const skillsDir = 'skills';
            const folders = fs.readdirSync(skillsDir).filter(f =>
              fs.statSync(path.join(skillsDir, f)).isDirectory()
            );

            let errors = 0;

            folders.forEach(folder => {
              const skillMd = path.join(skillsDir, folder, 'SKILL.md');
              if (!fs.existsSync(skillMd)) return;

              const content = fs.readFileSync(skillMd, 'utf8');

              // Check for frontmatter
              if (!content.startsWith('---')) {
                console.error('ERROR: ' + folder + '/SKILL.md missing frontmatter');
                errors++;
                return;
              }

              // Extract frontmatter
              const endIndex = content.indexOf('---', 3);
              if (endIndex === -1) {
                console.error('ERROR: ' + folder + '/SKILL.md has unclosed frontmatter');
                errors++;
                return;
              }

              const frontmatter = content.slice(3, endIndex);

              // Check for name field
              if (!frontmatter.includes('name:')) {
                console.error('ERROR: ' + folder + '/SKILL.md missing name in frontmatter');
                errors++;
              }

              // Check for description field
              if (!frontmatter.includes('description:')) {
                console.error('ERROR: ' + folder + '/SKILL.md missing description in frontmatter');
                errors++;
              }
            });

            if (errors > 0) {
              process.exit(1);
            }

            console.log('✓ All SKILL.md files have valid frontmatter');
          "

      - name: Run tests
        run: node test.js

      - name: Validate CLI loads
        run: node cli.js list > /dev/null && echo "✓ CLI loads successfully"
